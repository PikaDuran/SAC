<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Sistema SAT Mejorado</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { width: 100%; padding: 8px; box-sizing: border-box; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; cursor: pointer; }
        button:hover { background: #005a86; }
        .result { margin-top: 20px; padding: 15px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #cce7ff; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üõ†Ô∏è Prueba Sistema SAT Mejorado</h1>
    
    <div class="info">
        <strong>üí° Funcionalidades Disponibles:</strong><br>
        ‚Ä¢ ‚úÖ Selecci√≥n de un RFC espec√≠fico o TODOS los RFCs<br>
        ‚Ä¢ ‚úÖ Documentos Emitidas, Recibidas o Ambos (crea m√∫ltiples solicitudes)<br>
        ‚Ä¢ ‚úÖ Validaci√≥n de rango de fechas (m√°ximo 31 d√≠as)<br>
        ‚Ä¢ ‚úÖ Procesamiento en lotes para m√∫ltiples certificados<br>
    </div>

    <form id="testForm">
        <div class="form-group">
            <label for="rfc_selected">RFC:</label>
            <select id="rfc_selected" name="rfc_selected" required>
                <option value="">Seleccione RFC...</option>
                <option value="TODOS">üî• TODOS LOS RFCs (Batch)</option>
                <option value="1">BFM170822P38 (BOT FINANCE)</option>
                <option value="2">BLM1706026AA (BOT LEASE)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="tipo_documento">Tipo de Documento:</label>
            <select id="tipo_documento" name="tipo_documento" required>
                <option value="">Seleccione tipo...</option>
                <option value="Emitidas">üì§ Emitidas</option>
                <option value="Recibidas">üì• Recibidas</option>
                <option value="Ambos">üîÑ Ambos (Emitidas + Recibidas)</option>
            </select>
        </div>

        <div class="form-group">
            <label for="fecha_desde">Fecha Desde:</label>
            <input type="date" id="fecha_desde" name="fecha_desde" required>
        </div>

        <div class="form-group">
            <label for="fecha_hasta">Fecha Hasta:</label>
            <input type="date" id="fecha_hasta" name="fecha_hasta" required>
        </div>

        <button type="submit">üöÄ Solicitar Descarga SAT</button>
    </form>

    <div id="result"></div>

    <script>
        // Establecer fechas por defecto (√∫ltimos 30 d√≠as)
        const hoy = new Date();
        const hace30Dias = new Date();
        hace30Dias.setDate(hoy.getDate() - 30);

        document.getElementById('fecha_hasta').value = hoy.toISOString().split('T')[0];
        document.getElementById('fecha_desde').value = hace30Dias.toISOString().split('T')[0];

        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const result = document.getElementById('result');
            
            // Mostrar que est√° procesando
            result.innerHTML = '<div class="info">‚è≥ Procesando solicitud(es)...</div>';

            try {
                const response = await fetch('/SAC/public/contabilidad/sat/api/solicitar-descarga.php', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    let html = '<div class="result success">';
                    html += '<h3>‚úÖ ' + data.message + '</h3>';
                    
                    if (Array.isArray(data.data)) {
                        html += '<h4>Solicitudes creadas:</h4><ul>';
                        data.data.forEach(item => {
                            html += `<li><strong>${item.rfc}</strong> (${item.tipo}): ${item.request_id}</li>`;
                        });
                        html += '</ul>';
                    } else {
                        html += `<p><strong>Request ID:</strong> ${data.data.request_id}</p>`;
                        html += `<p><strong>RFC:</strong> ${data.data.rfc}</p>`;
                        html += `<p><strong>Tipo:</strong> ${data.data.tipo}</p>`;
                    }

                    if (data.warnings && data.warnings.length > 0) {
                        html += '<h4>‚ö†Ô∏è Advertencias:</h4><ul>';
                        data.warnings.forEach(warning => {
                            html += `<li>${warning}</li>`;
                        });
                        html += '</ul>';
                    }

                    html += '</div>';
                    result.innerHTML = html;
                } else {
                    result.innerHTML = `<div class="result error"><h3>‚ùå Error:</h3><p>${data.message}</p></div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="result error"><h3>‚ùå Error de conexi√≥n:</h3><p>${error.message}</p></div>`;
            }
        });

        // Validaci√≥n de fechas
        document.getElementById('fecha_desde').addEventListener('change', validarFechas);
        document.getElementById('fecha_hasta').addEventListener('change', validarFechas);

        function validarFechas() {
            const fechaDesde = new Date(document.getElementById('fecha_desde').value);
            const fechaHasta = new Date(document.getElementById('fecha_hasta').value);
            
            if (fechaDesde && fechaHasta) {
                const diffTime = Math.abs(fechaHasta - fechaDesde);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 31) {
                    alert(`‚ö†Ô∏è El rango de fechas no puede ser mayor a 31 d√≠as. Rango actual: ${diffDays} d√≠as`);
                    document.getElementById('fecha_desde').value = '';
                    document.getElementById('fecha_hasta').value = '';
                }
            }
        }
    </script>
</body>
</html>
