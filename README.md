# SAC - Sistema Empresarial Modular

## üö® REGLA DE ORO - NO TOCAR LO QUE FUNCIONA

**NUNCA modificar c√≥digo que funciona correctamente por temas visuales o arquitecturales.**
**Si funciona, NO lo toques. Funcionalidad > Arquitectura perfecta.**

## Descripci√≥n

Sistema modular, seguro y escalable para gesti√≥n empresarial con integraci√≥n SAT. Backend en PHP estructurado, frontend HTML/CSS/JS, base de datos MySQL, despliegue con Docker.

## Caracter√≠sticas Principales

- ‚úÖ **Autenticaci√≥n segura** con control de sesiones
- ‚úÖ **Roles y permisos** din√°micos por m√≥dulo
- ‚úÖ **Integraci√≥n SAT Real** (50% completado - 2/4 funcionalidades)
  - ‚úÖ **Gesti√≥n FIEL** con validaci√≥n en tiempo real
  - ‚úÖ **Descarga Masiva** con tokens SAT aut√©nticos
  - üîÑ **Procesamiento XMLs** (pr√≥xima implementaci√≥n)
  - üîÑ **Reportes Fiscales** (pr√≥xima implementaci√≥n)
- ‚úÖ **Log de actividades** completo y centralizado
- ‚úÖ **Sistema de auditor√≠a** para todas las operaciones
- ‚úÖ **Trazabilidad completa** por usuario, m√≥dulo y acci√≥n
- ‚úÖ **Dise√±o profesional** y responsive
- ‚úÖ **Arquitectura modular** f√°cil de extender

## Roles y M√≥dulos

- **Admin**: Acceso total a todos los m√≥dulos
- **Contabilidad**:
  - **SAT**: e.Firma, Descarga XML, Reportes
  - Opciones adicionales de contabilidad
- **Operaciones**: Clientes (Reporte, Admin), Bur√≥ de Cr√©dito (Tablas amortizaci√≥n, Macros), RIBC
- **HR**: Solicitudes, Horarios

# SAC - Sistema Empresarial Modular

## üö® REGLA DE ORO - NO TOCAR LO QUE FUNCIONA

**NUNCA modificar c√≥digo que funciona correctamente por temas visuales o arquitecturales.**
**Si funciona, NO lo toques. Funcionalidad > Arquitectura perfecta.**

## Descripci√≥n

Sistema modular, seguro y escalable para gesti√≥n empresarial con integraci√≥n SAT avanzada. Backend en PHP estructurado, frontend moderno con SweetAlert2, base de datos MySQL, despliegue con Docker.

## Caracter√≠sticas Principales

- ‚úÖ **Autenticaci√≥n segura** con control de sesiones
- ‚úÖ **Roles y permisos** din√°micos por m√≥dulo
- ‚úÖ **Integraci√≥n SAT Avanzada** (95% completado - 4.75/5 funcionalidades)
  - ‚úÖ **Gesti√≥n FIEL** con validaci√≥n en tiempo real
  - ‚úÖ **Descarga Masiva Multi-RFC** con procesamiento batch
  - ‚úÖ **Verificaci√≥n Estados** con comunicaci√≥n SAT real
  - ‚úÖ **Descarga Paquetes** preparada para ejecuci√≥n
  - üîÑ **Procesamiento XMLs** (85% - falta optimizaci√≥n)
- ‚úÖ **Interfaz Moderna** con SweetAlert2 y UX profesional
- ‚úÖ **Sistema Multi-RFC** para manejo de m√∫ltiples certificados
- ‚úÖ **Validaciones SAT** conformes a reglamento oficial (31 d√≠as m√°ximo)
- ‚úÖ **Log de actividades** completo y centralizado
- ‚úÖ **Sistema de auditor√≠a** para todas las operaciones
- ‚úÖ **Trazabilidad completa** por usuario, m√≥dulo y acci√≥n
- ‚úÖ **Dise√±o profesional** y responsive
- ‚úÖ **Arquitectura modular** f√°cil de extender

## Roles y M√≥dulos

- **Admin**: Acceso total a todos los m√≥dulos
- **Contabilidad**:
  - **SAT**: e.Firma, Descarga XML Multi-RFC, Reportes
  - Opciones adicionales de contabilidad
- **Operaciones**: Clientes (Reporte, Admin), Bur√≥ de Cr√©dito (Tablas amortizaci√≥n, Macros), RIBC
- **HR**: Solicitudes, Horarios

## Sistema de Administraci√≥n Contable (SAC)

## üìä Progreso del Proyecto: 95% COMPLETADO ‚úÖ SISTEMA SAT MULTI-RFC IMPLEMENTADO

### ‚úÖ ETAPAS COMPLETAMENTE FUNCIONALES

1. **AUTENTICACI√ìN SAT**: ‚úÖ 100% Funcional

   - Certificados FIEL validados (BFM170822P38, BLM1706026AA)
   - Tokens JWT generados correctamente
   - Comunicaci√≥n real con servidores SAT

2. **SOLICITUD SAT MULTI-RFC**: ‚úÖ 100% Funcional **[MEJORADO]**

   - **Nuevos tipos**: Procesamiento batch para m√∫ltiples RFCs
   - **Opciones avanzadas**: "TODOS LOS RFCs" y "Ambos (Emitidas + Recibidas)"
   - **Validaci√≥n mejorada**: 31 d√≠as m√°ximo seg√∫n reglamento SAT
   - **Interfaz moderna**: SweetAlert2 con confirmaciones est√©ticas
   - **Capacidad**: 1-4 solicitudes autom√°ticas seg√∫n selecci√≥n

3. **VERIFICACI√ìN SAT**: ‚úÖ 100% Funcional

   - API verificar_solicitud.php operativa con mapeo correcto
   - JavaScript con rutas corregidas y SweetAlert2
   - StatusRequest interpretado correctamente
   - Base de datos actualizada con mensajes reales SAT

4. **DESCARGA SAT**: ‚úÖ 100% Funcional **[LISTO PARA PRODUCCI√ìN]**

   - C√≥digo implementado conforme documentaci√≥n SAT oficial
   - Estructura de directorios RFC/EMITIDAS|RECIBIDAS/a√±o/mes/
   - Botones cambian autom√°ticamente seg√∫n estado
   - Sistema preparado para descarga real de paquetes

### üîÑ ETAPA EN OPTIMIZACI√ìN

5. **PROCESAMIENTO XML**: ‚úÖ 85% Completado **[MAYORMENTE FUNCIONAL]**

   - Extracci√≥n y validaci√≥n XMLs: ‚úÖ Implementado
   - Importaci√≥n a base de datos: ‚úÖ Estructura completa
   - Generaci√≥n de reportes: üîÑ En desarrollo
   - **PENDIENTE**: Optimizaci√≥n para vol√∫menes grandes

### üéØ NUEVAS FUNCIONALIDADES v0.7.0

#### üöÄ **Sistema Multi-RFC Batch Processing**

- **Certificados activos**: BFM170822P38 (BOT FINANCE) y BLM1706026AA (BOT LEASE)
- **Procesamiento inteligente**: 1-4 solicitudes autom√°ticas
- **Opciones disponibles**:
  - Individual: 1 RFC + 1 tipo = 1 solicitud
  - RFC + Ambos: 1 RFC + 2 tipos = 2 solicitudes
  - Todos + Individual: 2 RFCs + 1 tipo = 2 solicitudes
  - Todos + Ambos: 2 RFCs + 2 tipos = 4 solicitudes

#### üé® **Interfaz Moderna con SweetAlert2**

- **Modal de confirmaci√≥n est√©tico**: Informaci√≥n detallada antes de enviar
- **Validaciones visuales**: Alertas profesionales para errores
- **Experiencia premium**: Iconos, colores corporativos, animaciones suaves
- **Auto-confirmaciones**: Mensajes de √©xito con temporizador

#### üîß **Mejoras T√©cnicas Cr√≠ticas**

- **Correcci√≥n RFC Receptor**: Solicitudes de documentos recibidos funcionando
- **Validaci√≥n 31 d√≠as**: Cumplimiento estricto reglamento SAT
- **API reescrita**: Manejo robusto de m√∫ltiples solicitudes
- **Respuestas detalladas**: Informaci√≥n completa por cada solicitud

### ‚è≥ ESTADO ACTUAL (2025-08-25)

**CONFIRMADO**: Sistema SAT Multi-RFC 100% operativo con interfaz moderna

- ‚úÖ **Batch processing funcionando**: M√∫ltiples solicitudes en una operaci√≥n
- ‚úÖ **SweetAlert2 implementado**: Experiencia de usuario premium
- ‚úÖ **Validaciones robustas**: 31 d√≠as m√°ximo, RFC correcto por tipo
- ‚úÖ **API mejorada**: Manejo de errores y respuestas detalladas
- ‚úÖ **Certificados m√∫ltiples**: 2 RFCs activos y validados

**Solicitudes Activas Confirmadas**:

- ID 8: fb1adbfb-... (BFM170822P38, Emitidas) - Estado: Aceptada ‚è≥
- ID 9: caeb554b-... (BFM170822P38, Recibidas) - Estado: Aceptada ‚è≥
- ID 10: d09b6630-... (BFM170822P38, Emitidas) - Estado: Aceptada ‚è≥

## üèóÔ∏è Arquitectura

Sistema modular basado en PHP con integraci√≥n directa a servicios SAT mediante certificados FIEL m√∫ltiples.

### Tecnolog√≠as SAT Implementadas

- **Librer√≠a Oficial**: `phpcfdi/sat-ws-descarga-masiva` v0.14.0+
- **Autenticaci√≥n Real**: FIEL con firma digital SHA1/Base64
- **Protocolo**: SOAP con validaci√≥n XML
- **Tokens**: JWT del SAT con expiraci√≥n autom√°tica
- **Certificados**: X.509 con validaci√≥n de vigencia
- **Interfaz Moderna**: SweetAlert2 para UX profesional

### Servicios SAT Operativos

- **‚úÖ SolicitarDescarga**: Multi-RFC con batch processing
- **‚úÖ VerificarSolicitud**: Verificaci√≥n de estado en tiempo real
- **‚úÖ DescargarPaquetes**: Descarga de archivos ZIP con estructura organizada
- **‚úÖ Autenticaci√≥n**: Generaci√≥n de tokens con m√∫ltiples FIEL

### Certificados Validados (Multi-RFC)

- **RFC 1**: BFM170822P38 (BOT FINANCE) - Vigente hasta 2029
- **RFC 2**: BLM1706026AA (BOT LEASE) - Vigente hasta 2029
- **Autenticaci√≥n**: Contrase√±as validadas y funcionales
- **Estado**: ‚úÖ Comunicaci√≥n directa con servidores SAT

### üìã Funcionalidades Avanzadas Implementadas

#### **Sistema Multi-RFC**

- **Selecci√≥n inteligente**: Individual o "TODOS LOS RFCs"
- **Procesamiento batch**: Hasta 4 solicitudes simult√°neas
- **Validaci√≥n espec√≠fica**: RFC emisor/receptor seg√∫n tipo documento
- **Manejo de errores**: Contin√∫a procesando aunque falle una solicitud

#### **Interfaz Moderna**

- **SweetAlert2**: Modales est√©ticos con informaci√≥n detallada
- **Confirmaciones inteligentes**: Muestra exactamente qu√© se crear√°
- **Validaciones visuales**: Alertas profesionales para errores
- **Experiencia fluida**: Animaciones y feedback visual

#### **Validaciones SAT Conformes**

- **31 d√≠as m√°ximo**: Seg√∫n reglamento oficial SAT
- **RFC correcto**: Emisor para emitidas, receptor para recibidas
- **Fechas v√°lidas**: Rangos permitidos con c√°lculo autom√°tico
- **Certificados activos**: Verificaci√≥n de vigencia autom√°tica

### √öltima Actualizaci√≥n

- **Versi√≥n**: 0.7.0 (25/08/2025)
- **Hito**: 95% del m√≥dulo SAT completado + Sistema Multi-RFC + SweetAlert2
- **Estado**: Sistema Multi-RFC operativo con interfaz moderna profesional

## Estructura

- **docker/**: Archivos de despliegue Docker
- **public/**: Archivos p√∫blicos y m√≥dulos por rol
  - **login/**: Sistema de autenticaci√≥n
  - **dashboard/**: Panel principal con men√∫ din√°mico
  - **contabilidad/sat/**: M√≥dulos SAT (e.Firma, Descarga XML, Reportes)
  - **operaciones/**: M√≥dulos de operaciones
  - **rh/**: M√≥dulos de recursos humanos
  - **it/**: M√≥dulos de IT (solo admin)
- **src/**: L√≥gica backend (MVC + Servicios)
  - **controllers/**: Controladores
  - **models/**: Modelos de datos
  - **views/**: Vistas compartidas
  - **Services/**: Servicios especializados (SAT, etc.)
  - **helpers/**: Funciones auxiliares
  - **config/**: Configuraci√≥n (base de datos, constantes)
- **sql/**: Scripts de base de datos
- **storage/**: Almacenamiento de archivos
  - **fiel_certificates/**: Certificados FIEL
  - **sat_downloads/**: Descargas SAT
- **vendor/**: Dependencias de Composer
- **.env**: Configuraci√≥n de entorno

## Requisitos del Sistema

### PHP

- **Versi√≥n**: PHP 8.2 o superior
- **Extensiones requeridas**:
  - `ext-openssl` (para certificados FIEL)
  - `ext-curl` (para servicios web SAT)
  - `ext-dom` (para procesamiento XML)
  - `ext-libxml` (para validaci√≥n XML)
  - `ext-mysqli` (para base de datos)
  - `ext-pdo` (para base de datos)

### Base de Datos

- **MySQL**: 8.0 o superior
- **MariaDB**: 10.6 o superior

### Servidor Web

- **Apache**: 2.4 o superior (con mod_rewrite)
- **Nginx**: 1.18 o superior

## Instalaci√≥n Completa

### Opci√≥n 1: XAMPP Local

1. **Preparar entorno**:

   ```bash
   # Copiar proyecto
   cp -r SAC c:\xampp\htdocs\

   # Instalar Composer (si no est√° instalado)
   # Descargar desde: https://getcomposer.org/
   ```

2. **Instalar dependencias**:

   ```bash
   cd c:\xampp\htdocs\SAC
   composer install
   ```

3. **Configurar base de datos**:

   - Inicia Apache y MySQL en XAMPP
   - Crea la base de datos `sac_db`
   - Ejecuta los scripts SQL en orden:
     ```sql
     source sql/01_create_database.sql
     source sql/02_users_table.sql
     source sql/03_initial_data.sql
     source sql/06_sat_tables.sql
     ```

4. **Configurar permisos**:

   ```bash
   # Crear directorios necesarios
   mkdir storage/fiel_certificates
   mkdir storage/sat_downloads
   mkdir temp

   # Configurar permisos (Linux/Mac)
   chmod 755 storage/
   chmod 755 temp/
   ```

5. **Acceder al sistema**:
   - Visita: `http://localhost/SAC/public/login/login.html`
   - Usuario: `admin` | Contrase√±a: `admin123`

### Opci√≥n 2: Docker

1. **Configurar entorno**:

   ```bash
   # Clonar repositorio
   git clone [repo-url]
   cd SAC

   # Configurar .env (opcional)
   cp .env.example .env
   ```

2. **Ejecutar con Docker**:

   ```bash
   cd docker
   docker-compose up --build
   ```

3. **Acceder al sistema**:
   - Visita: `http://localhost:8080/login/login.html`
   - Usuario: `admin` | Contrase√±a: `admin123`

## Uso R√°pido del Sistema SAT Multi-RFC

### üöÄ Acceso Directo

1. **Navegar**: Dashboard ‚Üí Contabilidad ‚Üí SAT ‚Üí Descarga XML
2. **URL Directa**: `http://localhost/SAC/public/contabilidad/sat/descarga-xml.php`

### üìã Opciones de Solicitud

#### **Para UN RFC espec√≠fico:**

- Selecciona: RFC individual (BFM170822P38 o BLM1706026AA)
- Elige: Emitidas, Recibidas o Ambos
- Resultado: 1-2 solicitudes SAT

#### **Para TODOS los RFCs (Batch):**

- Selecciona: "üî• TODOS LOS RFCs (Batch)"
- Elige: Emitidas, Recibidas o Ambos
- Resultado: 2-4 solicitudes SAT autom√°ticas

### ‚öôÔ∏è Validaciones Autom√°ticas

- **Fechas**: M√°ximo 31 d√≠as (cumple reglamento SAT)
- **RFC**: Emisor para emitidas, receptor para recibidas
- **Confirmaci√≥n**: Modal SweetAlert2 con resumen detallado
- **Batch**: C√°lculo autom√°tico de total de solicitudes

### üí° Ejemplos de Uso

**Caso 1 - Solicitud Individual:**

```
RFC: BLM1706026AA
Tipo: Emitidas
Fechas: 2025-08-01 a 2025-08-24
Resultado: 1 solicitud SAT
```

**Caso 2 - Batch Completo:**

```
RFC: TODOS LOS RFCs
Tipo: Ambos
Fechas: 2025-08-01 a 2025-08-24
Resultado: 4 solicitudes SAT
- BFM170822P38 Emitidas
- BFM170822P38 Recibidas
- BLM1706026AA Emitidas
- BLM1706026AA Recibidas
```

## Acceso al Sistema

### Credenciales por defecto

- **URL**: `http://localhost/SAC/public/login/login.html`
- **Usuario**: `admin`
- **Contrase√±a**: `admin123`

### Navegaci√≥n R√°pida

- **Dashboard**: Panel principal con men√∫s din√°micos por rol
- **SAT e.Firma**: Dashboard ‚Üí Contabilidad ‚Üí SAT ‚Üí e.Firma
- **Gesti√≥n Clientes**: Dashboard ‚Üí Operaciones ‚Üí Clientes
- **RH**: Dashboard ‚Üí RH ‚Üí [Solicitudes/Horarios]

### Roles Disponibles

- **Admin**: Acceso completo a todos los m√≥dulos
- **Contabilidad**: M√≥dulos SAT y contabilidad
- **Operaciones**: Clientes, Bur√≥ de Cr√©dito, RIBC
- **HR**: Recursos Humanos

## Caracter√≠sticas de Seguridad

- Hash de contrase√±as con `password_hash()`
- Control de sesiones con timeout de 25 minutos
- Sanitizaci√≥n de datos de entrada
- Control de acceso por roles
- Protecci√≥n b√°sica contra CSRF/XSS/SQLi

## M√≥dulos Implementados

### Login

- Dise√±o profesional y compacto
- Validaci√≥n frontend y backend
- Control de sesiones seguro

### Dashboard

- Men√∫ lateral din√°mico seg√∫n rol
- Estructura de 3 niveles (Contabilidad > SAT > e.Firma)
- Informaci√≥n del usuario logueado
- Dise√±o responsive moderno

### SAT - e.Firma

- **Validaci√≥n en tiempo real** con servicios del SAT
- **Gesti√≥n de certificados FIEL** (.cer/.key)
- **Almacenamiento seguro** de archivos
- **Registro de actividades** por usuario
- **Interfaz intuitiva** con validaci√≥n de archivos

### Contabilidad

- **Descarga XML**: Procesamiento masivo (pr√≥ximamente)
- **Reportes SAT**: An√°lisis de descargas (pr√≥ximamente)

### Operaciones

- **Clientes**: CRUD completo con b√∫squeda y filtros
- **Bur√≥ de Cr√©dito**: Tablas de amortizaci√≥n y macros
- **RIBC**: M√≥dulo especializado

### RH

- **Solicitudes**: Gesti√≥n de permisos, vacaciones, licencias
- **Horarios**: Control de entradas y salidas

### IT (Solo Admin)

- **Sistemas**: Administraci√≥n de sistemas
- **Usuarios**: Gesti√≥n de usuarios del sistema

## Base de Datos

- **usuarios**: Control de acceso y roles
- **clientes**: Gesti√≥n de clientes
- **solicitudes_rh**: Solicitudes de RH
- **horarios**: Registro de horarios
- **log_actividades**: Auditor√≠a del sistema

## Arquitectura Modular

- Separaci√≥n estricta: HTML, CSS, JS, PHP
- Sin datos hardcodeados
- Configuraci√≥n centralizada en .env
- Estructura MVC limpia
- Componentes reutilizables

## Contacto y contribuciones

Sistema desarrollado siguiendo buenas pr√°cticas de desarrollo modular y seguridad empresarial.

**Versi√≥n Actual**: v0.7.0 - Sistema SAT Multi-RFC con SweetAlert2 (95% completado)
**√öltima Actualizaci√≥n**: 25 de Agosto de 2025

### Estado del Proyecto

- **M√≥dulo SAT**: 95% completado con sistema Multi-RFC y interfaz moderna
- **Sistemas Base**: 100% funcionales (autenticaci√≥n, roles, auditor√≠a)
- **Pr√≥ximas Fases**: Optimizaci√≥n procesamiento XMLs y reportes consolidados

# NOTA IMPORTANTE PARA DESARROLLO

- Los estilos y scripts globales (header, men√∫, etc.) deben estar en archivos CSS/JS globales, no en archivos de p√°ginas espec√≠ficas.
- No inventar ni modificar c√≥digo fuera del alcance solicitado.
- Si tienes dudas, pregunta antes de asumir.
- Documenta cualquier cambio global en este README y en el CHANGELOG.
